@using Blazorise
@using Blazorise.Components
@using ClimateExplorer.Core.Model;
@using GeoCoordinatePortable

<Modal @ref="modal">
    <ModalContent Size="ModalSize.Large">
        <ModalHeader Background="Background.Light">
            <ModalTitle>Change location</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            @if (SelectedLocation != null)
            {
                <Field>
                    Current location: <Strong>@SelectedLocation.FullTitle</Strong>
                </Field>
            }
            <Field>
                <FieldLabel>Click the "near me" button to find the station closest to you (the browser will ask to "know your location")</FieldLabel>
                <Button Clicked="@FireUseCurrentLocation" Color="Color.Primary">Near me</Button>

                @if (BrowserLocationErrorMessage != null)
                {
                    <div class="error-message">
                        @BrowserLocationErrorMessage
                    </div>
                }
            </Field>
            <Field> 
            </Field>
            <Field>
                <FieldLabel>Free text search for a location</FieldLabel>
                <Autocomplete TItem="Location"
                              TValue="Guid"
                              Data="@Locations"
                              TextField="@((item) => item.FullTitle)"
                              ValueField="@((item) => item.Id)"
                              Placeholder="Search..."
                              Filter="AutocompleteFilter.Contains"
                              FreeTyping
                              SelectedValueChanged="@OnLocationChange"
                              MaxMenuHeight="400px"
                              >
                     <NotFoundContent> Sorry... @context was not found! :( </NotFoundContent>
                 </Autocomplete>
            </Field>
            <Field>
                <FieldLabel>Select a location from the list</FieldLabel>
                <SelectList
                    TItem="Location"
                    TValue="Guid"
                    Data="@Locations"
                    TextField="@((item)=>item.FullTitle)"
                    ValueField="@((item)=>item.Id)"
                    SelectedValueChanged="@OnLocationChange"
                    DefaultItemText="Select location"
                    Style="width: 100%"
                    />
           </Field>
            @if (SelectedLocation != null)
            {
                <Field>
                    <FieldLabel>Select a nearby location</FieldLabel>
                    <Alert Color="Color.Secondary" Visible="true">
                        <Table Borderless Narrow>
                            <TableBody>
                                @foreach (var row in SelectedLocation.NearbyLocations!)
                                {
                                    <TableRow>
                                        <TableRowCell>
                                            <Blazorise.Link Title="@row.Title"
                                                                    To="#"
                                                                    Clicked="@(()=>FireOnLocationChange(row.LocationId))">
                                                        @row.Title
                                            </Blazorise.Link>
                                        </TableRowCell>
                                            <TableRowCell>@row.SubTitle</TableRowCell>
                                        <TableRowCell>
                                            <span style="color: #888">
                                                @(row.Distance) km
                                            </span>
                                        </TableRowCell>
                                        <TableRowCell>
                                            <span style="color: #888">
                                                @row.CompassRoseDirection
                                                <span style="display: inline-block; transform: rotate(@($"{row.BearingDegrees}deg"))">⭡</span>
                                            </span>
                                        </TableRowCell>
                                    </TableRow>
                                }
                            </TableBody>
                        </Table>
                    </Alert>
                </Field>
            }
        </ModalBody>
    </ModalContent>
</Modal>

@code {
    Modal? modal;

    [Parameter]
    public IEnumerable<Location>? Locations { get; set; }

    [Parameter]
    public Location? SelectedLocation { get; set; }

    [Parameter]
    public string? BrowserLocationErrorMessage { get; set; }

    [Parameter]
    public EventCallback<Guid> OnLocationChange { get; set; }

    [Parameter]
    public EventCallback SetCurrentLocation { get; set; }

    protected override void OnParametersSet()
    {
        if (Locations != null)
        {
            Locations = Locations.OrderBy(x => x.Name);    
        }
    }

    public Task Show()
    {
        return modal!.Show();
    }
    public Task Hide()
    {
        return modal!.Hide();
    }

    async Task FireUseCurrentLocation()
    {
        await SetCurrentLocation.InvokeAsync();
    }

    async Task FireOnLocationChange(Guid locationId)
    {
        await OnLocationChange.InvokeAsync(locationId);
    }
}
