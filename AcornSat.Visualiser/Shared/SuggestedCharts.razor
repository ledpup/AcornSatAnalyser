@using AcornSat.Core.ViewModel
@using AcornSat.Visualiser.UiModel
@using Blazorise
@using Blazorise.Components
@using Blazorise.Charts
@using static AcornSat.Core.Enums

<div class="suggested-data-set-list">
    @foreach (var s in SuggestedPresets)
    {
        <div class="suggested-data-set" @onclick="() => OnChartPresetSelected.InvokeAsync(s.ChartSeriesList)">
            <div class="main">
                <div class="title">@s.Title</div>
                <div class="description">@s.Description</div>
            </div>
            <div class="expander">
                <span class="oi oi-chevron-bottom" aria-hidden="true"></span>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public IEnumerable<DataSetDefinitionViewModel> DataSetDefinitions { get; set; }

    [Parameter]
    public Location SelectedLocation { get; set; }

    [Parameter]
    public EventCallback<List<ChartSeriesDefinition>> OnChartPresetSelected { get; set; }

    List<SuggestedChartPresetModelWithVariants> SuggestedPresets { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        SuggestedPresets = new List<SuggestedChartPresetModelWithVariants>();

        if (SelectedLocation == null) return;

        var dsdLocation = DataSetDefinitions.Single(x => x.Id == SelectedLocation.DataSetId);

        var mdTempMax =
            dsdLocation.MeasurementDefinitions.SingleOrDefault(x => x.DataType == DataType.TempMax && x.DataAdjustment == DataAdjustment.Adjusted) ??
            dsdLocation.MeasurementDefinitions.SingleOrDefault(x => x.DataType == DataType.TempMax && x.DataAdjustment == null);

        var mdRainfall =
            dsdLocation.MeasurementDefinitions.SingleOrDefault(x => x.DataType == DataType.Rainfall && x.DataAdjustment == null);

        var dsdMeiV2 = DataSetDefinitions.Single(x => x.Id == Guid.Parse("ffd5f5e2-d8df-4779-a7f4-f5d148505033"));
        var mdMeiV2 = dsdMeiV2.MeasurementDefinitions.Single(x => x.DataType == DataType.MEIv2);

        SuggestedPresets.Add(
            new SuggestedChartPresetModelWithVariants()
                {
                    Title = "Temperature + Rainfall",
                    Description = "Smoothed maximum daily temperature and rainfall",
                    ChartSeriesList =
                        new List<ChartSeriesDefinition>()
                        {
                            new ChartSeriesDefinition()
                            {
                                LocationId = SelectedLocation.Id,
                                LocationName = SelectedLocation.Name,
                                Aggregation = SeriesAggregationOptions.Mean,
                                DataResolution = DataResolution.Yearly,
                                DataSetDefinition = dsdLocation,
                                MeasurementDefinition = mdTempMax,
                                Smoothing = SeriesSmoothingOptions.MovingAverage,
                                SmoothingWindow = 20,
                                Value = SeriesValueOptions.Value,
                                Year = null
                            },
                            new ChartSeriesDefinition()
                            {
                                LocationId = SelectedLocation.Id,
                                LocationName = SelectedLocation.Name,
                                Aggregation = SeriesAggregationOptions.Sum,
                                DataResolution = DataResolution.Yearly,
                                DataSetDefinition = dsdLocation,
                                MeasurementDefinition = mdRainfall,
                                Smoothing = SeriesSmoothingOptions.MovingAverage,
                                SmoothingWindow = 20,
                                Value = SeriesValueOptions.Value,
                                Year = null
                            }

                        }
                }
        );

        SuggestedPresets.Add(
            new SuggestedChartPresetModelWithVariants()
            {
                Title = "Temperature",
                Description = "Yearly view of average maximum daily temperature",
                ChartSeriesList =
                    new List<ChartSeriesDefinition>()
                    {
                        new ChartSeriesDefinition()
                        {
                            LocationId = SelectedLocation.Id,
                            LocationName = SelectedLocation.Name,
                            Aggregation = SeriesAggregationOptions.Mean,
                            DataResolution = DataResolution.Yearly,
                            DataSetDefinition = dsdLocation,
                            MeasurementDefinition = mdTempMax,
                            Smoothing = SeriesSmoothingOptions.None,
                            SmoothingWindow = 5,
                            Value = SeriesValueOptions.Value,
                            Year = null
                        }
                    },
                Variants = 
                    new List<SuggestedChartPresetModel>()
                    {
                        new SuggestedChartPresetModel()
                        {
                            Title = "Plus trendline",
                            Description = "Adds a straight line, fit to the data",
                            ChartSeriesList =
                                new List<ChartSeriesDefinition>()
                                {
                                    new ChartSeriesDefinition()
                                    {
                                        LocationId = SelectedLocation.Id,
                                        LocationName = SelectedLocation.Name,
                                        Aggregation = SeriesAggregationOptions.Mean,
                                        DataResolution = DataResolution.Yearly,
                                        DataSetDefinition = dsdLocation,
                                        MeasurementDefinition = mdTempMax,
                                        Smoothing = SeriesSmoothingOptions.None,
                                        SmoothingWindow = 5,
                                        Value = SeriesValueOptions.Value,
                                        Year = null
                                    },
                                    new ChartSeriesDefinition()
                                    {
                                        LocationId = SelectedLocation.Id,
                                        LocationName = SelectedLocation.Name,
                                        Aggregation = SeriesAggregationOptions.Mean,
                                        DataResolution = DataResolution.Yearly,
                                        DataSetDefinition = dsdLocation,
                                        MeasurementDefinition = mdTempMax,
                                        Smoothing = SeriesSmoothingOptions.Trendline,
                                        SmoothingWindow = 5,
                                        Value = SeriesValueOptions.Value,
                                        Year = null
                                    }
                                }
                        },
                        new SuggestedChartPresetModel()
                        {
                            Title = "Plus moving average",
                            Description = "Adds a 5 year moving average",
                            ChartSeriesList =
                                new List<ChartSeriesDefinition>()
                                {
                                    new ChartSeriesDefinition()
                                    {
                                        LocationId = SelectedLocation.Id,
                                        LocationName = SelectedLocation.Name,
                                        Aggregation = SeriesAggregationOptions.Mean,
                                        DataResolution = DataResolution.Yearly,
                                        DataSetDefinition = dsdLocation,
                                        MeasurementDefinition = mdTempMax,
                                        Smoothing = SeriesSmoothingOptions.None,
                                        SmoothingWindow = 5,
                                        Value = SeriesValueOptions.Value,
                                        Year = null
                                    },
                                    new ChartSeriesDefinition()
                                    {
                                        LocationId = SelectedLocation.Id,
                                        LocationName = SelectedLocation.Name,
                                        Aggregation = SeriesAggregationOptions.Mean,
                                        DataResolution = DataResolution.Yearly,
                                        DataSetDefinition = dsdLocation,
                                        MeasurementDefinition = mdTempMax,
                                        Smoothing = SeriesSmoothingOptions.MovingAverage,
                                        SmoothingWindow = 5,
                                        Value = SeriesValueOptions.Value,
                                        Year = null
                                    }
                                }
                        },
                        new SuggestedChartPresetModel()
                        {
                            Title = "Moving average only",
                            Description = "Shows only a 5 year moving average",
                            ChartSeriesList =
                                new List<ChartSeriesDefinition>()
                                {
                                    new ChartSeriesDefinition()
                                    {
                                        LocationId = SelectedLocation.Id,
                                        LocationName = SelectedLocation.Name,
                                        Aggregation = SeriesAggregationOptions.Mean,
                                        DataResolution = DataResolution.Yearly,
                                        DataSetDefinition = dsdLocation,
                                        MeasurementDefinition = mdTempMax,
                                        Smoothing = SeriesSmoothingOptions.MovingAverage,
                                        SmoothingWindow = 5,
                                        Value = SeriesValueOptions.Value,
                                        Year = null
                                    }
                                }
                        }
                    }
            }
        );

        SuggestedPresets.Add(
            new SuggestedChartPresetModelWithVariants()
            {
                Title = "Temperature + ENSO MEIv.2",
                Description = "Yearly view of average maximum daily temperature, plus the El Niño Southern Oscillation MEIv.2 index",
                ChartSeriesList =
                    new List<ChartSeriesDefinition>()
                    {
                        new ChartSeriesDefinition()
                        {
                            LocationId = SelectedLocation.Id,
                            LocationName = SelectedLocation.Name,
                            Aggregation = SeriesAggregationOptions.Mean,
                            DataResolution = DataResolution.Yearly,
                            DataSetDefinition = dsdLocation,
                            MeasurementDefinition = mdTempMax,
                            Smoothing = SeriesSmoothingOptions.None,
                            SmoothingWindow = 5,
                            Value = SeriesValueOptions.Value,
                            Year = null
                        },
                        new ChartSeriesDefinition()
                        {
                            Aggregation = SeriesAggregationOptions.Mean,
                            DataResolution = DataResolution.Yearly,
                            DataSetDefinition = dsdMeiV2,
                            MeasurementDefinition = mdMeiV2,
                            Smoothing = SeriesSmoothingOptions.None,
                            SmoothingWindow = 5,
                            DisplayStyle = SeriesDisplayStyle.Bar,
                            Value = SeriesValueOptions.Value,
                            Year = null
                        }
                    }
            }
        );
    }
}
